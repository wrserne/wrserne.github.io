<!DOCTYPE html>
<html>
<head>
  <title>Reef-pi Example</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="./requests.js"></script>
  <script>
    // Replace the following variables with your own values
    const REEF_PI_IP_ADDRESS = '192.168.68.61';
    const REEF_PI_PORT = '8080';
    const USERNAME = 'reef-pi';
    const PASSWORD = 'reef-pi';

    // Authenticate with Reef-pi and retrieve the session ID and API key
    authenticateWithReefPi((error, { sessionId, apiKey }) => {
      if (error) {
        console.error('Failed to authenticate with Reef-pi:', error);
        return;
      }

      // Get the current temperature reading from a probe named "Temp Probe 1"
      getCurrentTemperature(sessionId, apiKey, 'Temp Probe 1', (error, temperature) => {
        if (error) {
          console.error('Failed to get current temperature:', error);
          return;
        }
        $('#temperature').text(temperature);
      });
    });

    function authenticateWithReefPi(callback) {
      // Send a GET request to the login endpoint to retrieve the session ID
      const loginUrl = `http://${REEF_PI_IP_ADDRESS}:${REEF_PI_PORT}/login`;
      $.get(loginUrl, (response) => {
        // Extract the session ID from the response
        const sessionId = response.headers['set-cookie'][0].split(';')[0].split('=')[1];

        // Generate the digest hash using the password and the session ID
        const digest = generateDigest(PASSWORD, sessionId);

        // Send a POST request to the login endpoint with the digest hash
        const postData = { username: USERNAME, password: digest };
        const options = {
          url: loginUrl,
          json: true,
          headers: { 'X-Api-Key': digest },
          body: postData,
        };
        $.post(options, (response) => {
          // Return the session ID and API key in the callback
          const sessionId = response.headers['set-cookie'][0].split(';')[0].split('=')[1];
          const apiKey = response.headers['x-api-key'];
          callback(null, { sessionId, apiKey });
        }).fail((error) => {
          callback(error);
        });
      }).fail((error) => {
        callback(error);
      });
    }

    function generateDigest(password, sessionId) {
      const hmac = require('crypto').createHmac('sha256', password);
      hmac.update(sessionId);
      return hmac.digest('hex');
    }

    function getCurrentTemperature(sessionId, apiKey, probeName, callback) {
      const url = `http://${REEF_PI_IP_ADDRESS}:${REEF_PI_PORT}/api/tc/${probeName}`;
      const headers = { 'X-Session-ID': sessionId, 'X-API-Key': apiKey };
      $.get({ url, headers, json: true }, (response) => {
        callback(null, response.current);
      }).fail((error) => {
        callback(error);
      });
    }
  </script>
</head>
<body>
  <h1>Current temperature:</h1>
  <p id="temperature"></p>
</body>
</html>